# RacelineOptimizer

This is the PSO algoritm for raceline optimization.

## Prerequisites

- [.NET SDK](https://dotnet.microsoft.com/download) (version 6.0 or later) - To run C#

## How to Run

1. **CD to this directory** (if you haven't already):

    ```bash
    cd Backend/RacelineOptimizer
    ```

2. **Restore dependencies**:

    ```bash
    dotnet restore
    ```

3. **Prepare the project**:

    - Create a folder to take input.
        ```bash
        mkdir Input
        ```
    - Place .bin file(s) generated by the image generator in the Input folder.

4. **Run the project**:

    ```bash
    dotnet run
    ```

    - Select which file from the list you'd like to run the optimizer on.

## Using the interface class ##
- Call the PSOInterface class to use this for integration
- Run(string edgeDataFilePath, string outPath, int numParticles = 100, int iterations = 60000)
    - edgeDataFilePath: The path of the .bin file created by the image processing python script.
    - outPath: The path of the output bin file that contains the racing line and the track borders.
    - numParticles and iterations: Could be usefull at another time, but leave as default for now.


## Project Structure

- `main.cs` - Debug main.
- `PSO.cs` - Main particle swarm algorithm to get optimized racelines.
- `Particle.cs` - Represents particles for PSO.
- `EdgeDataImporter.cs` - Imports .bin files.
- `TrackSampler.cs` - Samples track into less segments to speed up algorithm.
- `RacelineExporter.cs` - Creates a new .bin file that contains the race track with the raceline.
- `CornerDetector.cs` - Detects corners on track boundaries and stores them.
- `RacelineVisualizer.cs` - Exports raceline on top of track to image (For visualization)
- `SavitzkyGolayFilter.cs` - Smooths the racing line.
- `./Input` - Folder for .bin files that needs to be processed.
- `./Output` - Export directory.

## Notes

- For additional commands, see the [official .NET CLI documentation](https://docs.microsoft.com/dotnet/core/tools/).
- This is starting to optimize race lines properly. It just needs some minor tuning.

## Example reader for output .bin file
```C#
using System;
using System.Collections.Generic;
using System.IO;
using System.Numerics;

namespace RacelineOptimizer
{
    public class RacelineData
    {
        public List<Vector2> OuterBoundary { get; set; }
        public List<Vector2> InnerBoundary { get; set; }
        public List<Vector2> Raceline { get; set; }
    }

    public static class RacelineImporter
    {
        public static RacelineData LoadFromBinary(string filePath)
        {
            var data = new RacelineData();

            using (var fs = new FileStream(filePath, FileMode.Open, FileAccess.Read))
            using (var br = new BinaryReader(fs))
            {
                data.OuterBoundary = ReadPoints(br);
                data.InnerBoundary = ReadPoints(br);
                data.Raceline = ReadPoints(br);

                int trailing = br.ReadInt32();
                if (trailing != 0)
                {
                    Console.WriteLine("Warning: trailing value is not zero. File format may be corrupted.");
                }
            }

            return data;
        }

        private static List<Vector2> ReadPoints(BinaryReader br)
        {
            int count = br.ReadInt32();
            var list = new List<Vector2>(count);
            for (int i = 0; i < count; i++)
            {
                float x = br.ReadSingle();
                float y = br.ReadSingle();
                list.Add(new Vector2(x, y));
            }
            return list;
        }
    }
}
```